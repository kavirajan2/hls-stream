label: HLS (Single Bitrate)

inputs:
  - name: input
    label: Input File
    type: string
    required: true
    
  - name: output
    label: Output Directory
    type: string
    required: true
    
tasks:       

  - type: bash
    label: OpenSSL to create the key
    script: | 
      openssl rand 16 > /videos/enc.key

  - type: bash
    label: create ssh file
    script: | 
      KEY="$(openssl rand -hex 16)"
      echo "https://transcoding.contus.us/work/output/enc.key
      enc.key
      ${KEY}" > /videos/enc.keyinfo

  - type: bash
    label: Copy Encryption File to Output folder
    script: | 
      cp /videos/enc.key /videos/enc.keyinfo ${output}

  - type: parallel
    label: Generate the HLS streams
    tasks:            
    
    - label: Generate 360p HLS stream
      type: ffmpeg
      options: [
        -y, 
        -i, "${input}",
        -vf,"scale=w=-2:h=360",
        "-c:a", aac,
        "-ar","48000",
        "-b:a","96k", 
        "-c:v","h264",
        "-profile:v",main,
        -crf,20,
        -g,48,
        -keyint_min,48,
        -sc_threshold,0, 
        "-b:v",800k,
        -maxrate,856k,
        -bufsize,1200k,
        -hls_time,4,
        -hls_key_info_file, "/videos/enc.keyinfo",
        -hls_playlist_type,vod,
        -hls_segment_filename,"${output}/360p_%03d.ts","${output}/360p.m3u8"
    ]
